<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üö¶ Predictor de Congesti√≥n Vial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        form label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        form input,
        form select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1.2rem;
            background: #fff;
        }

        input:focus,
        select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            padding: 1rem 2.5rem;
            font-size: 1.125rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .result-fast {
            color: #10b981;
        }

        .result-moderate {
            color: #f59e0b;
        }

        .result-slow {
            color: #ef4444;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen">
    <div class="text-center py-8">
        <h1 class="text-5xl font-bold text-white mb-2"><i class="fas fa-traffic-light mr-3"></i> Predictor de Congesti√≥n
            Vial</h1>
        <p class="text-white/80 text-lg">Inteligencia Artificial para predecir el tr√°fico en tiempo real</p>
    </div>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <form id="predictForm" class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">

                        <!-- üåç Ubicaci√≥n & Tr√°fico -->
                        <!-- üåç Ubicaci√≥n & Tr√°fico -->
                        <div>
                            <h3 class="section-title text-blue-600">
                                <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci√≥n & Tr√°fico
                            </h3>

                            <label>Severidad
                                <select name="severity" required>
                                    <option value="0">0 - Muy leve</option>
                                    <option value="1">1 - Leve</option>
                                    <option value="2" selected>2 - Moderada</option>
                                    <option value="3">3 - Grave</option>
                                </select>
                            </label>

                            <label>Distancia (millas)
                                <input type="number" step="0.1" name="distance_mi" value="2.0" required>
                            </label>

                            <!-- ‚úÖ Latitud con datalist -->
                            <label>Latitud
                                <input list="latitudes" name="start_lat" value="38.90" step="0.0001" required>
                                <datalist id="latitudes">
                                    <option value="25.76">25.76 ‚Äì Miami, FL</option>
                                    <option value="34.05">34.05 ‚Äì Los √Ångeles, CA</option>
                                    <option value="38.90">38.90 ‚Äì Washington, DC</option>
                                    <option value="40.71">40.71 ‚Äì Nueva York, NY</option>
                                    <option value="41.88">41.88 ‚Äì Chicago, IL</option>
                                </datalist>
                            </label>

                            <!-- ‚úÖ Longitud con datalist -->
                            <label>Longitud
                                <input list="longitudes" name="start_lng" value="-77.03" step="0.0001" required>
                                <datalist id="longitudes">
                                    <option value="-80.19">-80.19 ‚Äì Miami, FL</option>
                                    <option value="-118.24">-118.24 ‚Äì Los √Ångeles, CA</option>
                                    <option value="-77.03">-77.03 ‚Äì Washington, DC</option>
                                    <option value="-74.00">-74.00 ‚Äì Nueva York, NY</option>
                                    <option value="-87.63">-87.63 ‚Äì Chicago, IL</option>
                                </datalist>
                            </label>

                            <!-- ‚úÖ Retrasos con sugerencias -->
                            <label>Retraso t√≠pico (mins)
                                <input list="typical_delays" type="number" step="0.1"
                                    name="delay_from_typical_traffic_mins" value="3.0" required>
                                <datalist id="typical_delays">
                                    <option value="2.0">2.0 ‚Äì Bajo</option>
                                    <option value="3.0">3.0 ‚Äì Promedio</option>
                                    <option value="5.0">5.0 ‚Äì Moderado</option>
                                    <option value="10.0">10.0 ‚Äì Alto</option>
                                </datalist>
                            </label>

                            <label>Retraso flujo libre (mins)
                                <input list="freeflow_delays" type="number" step="0.1"
                                    name="delay_from_free_flow_speed_mins" value="5.0" required>
                                <datalist id="freeflow_delays">
                                    <option value="3.0">3.0 ‚Äì Bajo</option>
                                    <option value="5.0">5.0 ‚Äì Promedio</option>
                                    <option value="8.0">8.0 ‚Äì Alto</option>
                                    <option value="12.0">12.0 ‚Äì Muy alto</option>
                                </datalist>
                            </label>
                        </div>


                        <!-- üèôÔ∏è Regi√≥n -->
                        <div>
                            <h3 class="section-title text-green-600"><i class="fas fa-city mr-2"></i>Regi√≥n</h3>

                            <label>Estado
                                <select name="state" required></select>
                            </label>

                            <label>Condado
                                <select name="county" required></select>
                            </label>

                            <label>Zona Horaria
                                <select name="local_time_zone">
                                    <option value="US/Eastern">US/Eastern</option>
                                    <option value="US/Central">US/Central</option>
                                    <option value="US/Mountain">US/Mountain</option>
                                    <option value="US/Pacific">US/Pacific</option>
                                </select>
                            </label>

                            <h3 class="section-title text-purple-600 mt-6"><i class="fas fa-clock mr-2"></i>Tiempo</h3>

                            <label>Hora
                                <input type="number" name="hour" value="8" min="0" max="23">
                            </label>

                            <!-- ‚úÖ D√≠a de la semana en texto -->
                            <label>D√≠a de la semana
                                <select name="day_of_week" required>
                                    <option value="0">Domingo</option>
                                    <option value="1">Lunes</option>
                                    <option value="2" selected>Martes</option>
                                    <option value="3">Mi√©rcoles</option>
                                    <option value="4">Jueves</option>
                                    <option value="5">Viernes</option>
                                    <option value="6">S√°bado</option>
                                </select>
                            </label>

                            <!-- ‚úÖ Mes en texto -->
                            <label>Mes
                                <select name="month" required>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5" selected>Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </label>

                            <!-- ‚úÖ A√±o como desplegable -->
                            <label>A√±o
                                <select name="year" required>
                                    <option value="2016">2016</option>
                                    <option value="2017">2017</option>
                                    <option value="2018" selected>2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </label>

                            <label>¬øEs fin de semana?
                                <select name="is_weekend">
                                    <option value="0" selected>No</option>
                                    <option value="1">S√≠</option>
                                </select>
                            </label>

                            <label>Duraci√≥n (mins)
                                <input type="number" name="duration_mins" value="60">
                            </label>
                        </div>


                        <!-- üå§Ô∏è Clima -->
                        <div>
                            <h3 class="section-title text-orange-600"><i class="fas fa-cloud-sun mr-2"></i>Condiciones
                                Clim√°ticas</h3>

                            <label>Temperatura (¬∞F)
                                <input type="number" name="temperature_f" value="58">
                            </label>

                            <label>Sensaci√≥n t√©rmica (¬∞F)
                                <input type="number" name="windchill_f" value="58">
                            </label>

                            <label>Humedad (%)
                                <input type="number" name="humidity" value="94" min="0" max="100">
                            </label>

                            <label>Presi√≥n (in)
                                <input type="number" step="0.01" name="pressure_in" value="29.46">
                            </label>

                            <label>Visibilidad (mi)
                                <input type="number" step="0.1" name="visibility_mi" value="1">
                            </label>

                            <!-- ‚úÖ Direcci√≥n del viento como desplegable -->
                            <label>Direcci√≥n del viento
                                <select name="wind_dir" required>
                                    <option value="CALM" selected>CALM</option>
                                    <option value="E">E</option>
                                    <option value="ENE">ENE</option>
                                    <option value="ESE">ESE</option>
                                    <option value="East">East</option>
                                    <option value="N">N</option>
                                    <option value="NE">NE</option>
                                    <option value="NNE">NNE</option>
                                    <option value="NNW">NNW</option>
                                    <option value="NW">NW</option>
                                    <option value="North">North</option>
                                    <option value="S">S</option>
                                    <option value="SE">SE</option>
                                    <option value="SSE">SSE</option>
                                    <option value="SSW">SSW</option>
                                    <option value="SW">SW</option>
                                    <option value="South">South</option>
                                    <option value="VAR">VAR</option>
                                    <option value="Variable">Variable</option>
                                    <option value="W">W</option>
                                    <option value="WNW">WNW</option>
                                    <option value="WSW">WSW</option>
                                    <option value="West">West</option>
                                </select>
                            </label>

                            <label>Velocidad del viento (mph)
                                <input type="number" step="0.1" name="windspeed_mph" value="0.0">
                            </label>

                            <label>Precipitaci√≥n (in)
                                <input type="number" step="0.1" name="precipitation_in" value="0.0">
                            </label>

                            <!-- ‚úÖ Condiciones clim√°ticas como desplegable -->
                            <label>Condiciones clim√°ticas
                                <select name="weather_conditions" required>
                                    <option value="Clear">Clear</option>
                                    <option value="Cloudy" selected>Cloudy</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Light Snow">Light Snow</option>
                                    <option value="Mostly Cloudy">Mostly Cloudy</option>
                                    <option value="Overcast">Overcast</option>
                                    <option value="Partly Cloudy">Partly Cloudy</option>
                                    <option value="Other">Other</option>
                                </select>
                            </label>
                        </div>

                    </div>

                    <div class="text-center mt-8">
                        <button type="submit" class="btn-primary"><i class="fas fa-brain mr-2"></i> Predecir
                            Congesti√≥n</button>
                    </div>
                </form>
            </div>

            <div>
                <div class="bg-white/95 rounded-3xl shadow-2xl p-6 mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-center"><i class="fas fa-chart-line mr-2"></i> Resultado de
                        Predicci√≥n</h3>
                    <div id="result" class="text-center text-gray-500">
                        <i class="fas fa-info-circle mr-2"></i> Completa el formulario y haz clic en "Predecir"
                    </div>
                </div>

                <div class="bg-white/95 rounded-3xl shadow-2xl p-6">
                    <h4 class="text-lg font-semibold mb-3"><i class="fas fa-server mr-2"></i> Estado de la API</h4>
                    <div id="apiStatus" class="flex items-center">
                        <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                        <span class="text-gray-600">Verificando conexi√≥n...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            // ‚úÖ Verificar conexi√≥n con la API
            try {
                const res = await fetch("https://server-congestion-predictor-production.up.railway.app/health");
                const data = await res.json();
                document.getElementById("apiStatus").innerHTML = data.status === "ok"
                    ? `<div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div><span class="text-green-600">API conectada ‚úì</span>`
                    : `<div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div><span class="text-red-600">API desconectada ‚úó</span>`;
            } catch {
                document.getElementById("apiStatus").innerHTML = `<div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div><span class="text-red-600">Error de conexi√≥n ‚úó</span>`;
            }

            // ‚úÖ Cargar estados y condados
            const countiesByState = {
                "AL": ["Baldwin", "Jefferson", "Madison", "Mobile"],
                "AR": ["Pulaski"],
                "AZ": ["Coconino", "Maricopa", "Pima"],
                "CA": ["Alameda", "Contra Costa", "El Dorado", "Kern", "Los Angeles", "Marin", "Monterey", "Napa", "Orange", "Placer", "Riverside", "Sacramento", "San Bernardino", "San Diego", "San Francisco", "San Joaquin", "San Mateo", "Santa Barbara", "Santa Clara", "Santa Cruz", "Solano", "Sonoma", "Stanislaus", "Ventura", "Yolo", "Nevada"],
                "CO": ["Adams", "Arapahoe", "Boulder", "Clear Creek", "Denver", "Douglas", "Eagle", "Garfield", "Jefferson", "Larimer", "Weld"],
                "CT": ["Fairfield", "Hartford", "Middlesex", "New Haven"],
                "DC": ["District of Columbia"],
                "DE": ["New Castle"],
                "FL": ["Bay", "Brevard", "Broward", "Collier", "Duval", "Hillsborough", "Lee", "Manatee", "Martin", "Miami-Dade", "Okaloosa", "Orange", "Osceola", "Palm Beach", "Pasco", "Pinellas", "Polk", "Sarasota", "Seminole", "St. Johns", "Volusia", "Walton"],
                "GA": ["Chatham", "Cherokee", "Clayton", "Cobb", "DeKalb", "Dekalb", "Fulton", "Gwinnett", "Henry"],
                "IA": ["Polk"],
                "IL": ["Cook", "DuPage", "Kane", "Lake", "Will"],
                "IN": ["Marion"],
                "KY": ["Boone", "Fayette", "Jefferson"],
                "LA": ["East Baton Rouge", "Jefferson", "Orleans"],
                "MA": ["Barnstable", "Bristol", "Hampden", "Middlesex", "Norfolk", "Plymouth", "Suffolk", "Worcester"],
                "MD": ["Anne Arundel", "Baltimore City", "Baltimore County", "Carroll", "Frederick", "Howard", "Montgomery", "Prince George's"],
                "MI": ["Macomb", "Oakland", "Washtenaw", "Wayne"],
                "MN": ["Hennepin", "Ramsey"],
                "MO": ["Boone", "Greene", "Jackson", "St. Charles", "St. Louis County"],
                "NC": ["Buncombe", "Mecklenburg", "Wake"],
                "NH": ["Rockingham"],
                "NJ": ["Bergen", "Burlington", "Camden", "Essex", "Hudson", "Middlesex", "Monmouth", "Morris", "Ocean", "Passaic", "Somerset", "Sussex"],
                "NM": ["Bernalillo"],
                "NV": ["Clark", "Washoe"],
                "NY": ["Albany", "Bronx", "Kings", "Nassau", "New York", "Queens", "Richmond", "Rockland", "Suffolk", "Westchester"],
                "OH": ["Cuyahoga", "Franklin", "Summit"],
                "OK": ["Oklahoma", "Tulsa"],
                "OR": ["Clackamas", "Columbia", "Multnomah", "Umatilla"],
                "PA": ["Allegheny", "Berks", "Bucks", "Butler", "Carbon", "Chester", "Crawford", "Cumberland", "Dauphin", "Delaware", "Erie", "Lancaster", "Lehigh", "Montgomery", "Philadelphia", "Westmoreland"],
                "RI": ["Providence"],
                "SC": ["Charleston", "Greenville", "Horry", "Jasper", "Lexington", "Richland"],
                "TN": ["Davidson", "Knox", "Shelby", "Sevier"],
                "TX": ["Bexar", "Collin", "Dallas", "Denton", "Fort Bend", "Galveston", "Harris", "Hidalgo", "McLennan", "Smith", "Tarrant", "Travis", "Webb", "Williamson"],
                "UT": ["Salt Lake", "Utah"],
                "VA": ["Arlington", "Fairfax", "Fairfax County", "Loudoun", "Prince William", "Richmond", "Richmond City", "Stafford"],
                "WA": ["King", "Kittitas", "Pierce", "Snohomish", "Spokane"],
                "WI": ["Milwaukee"],
                "Other": ["Other"]
            };

            const stateSelect = document.querySelector("select[name='state']");
            const countySelect = document.querySelector("select[name='county']");

            stateSelect.innerHTML = Object.keys(countiesByState).map(s => `<option value="${s}">${s}</option>`).join("");
            countySelect.innerHTML = countiesByState[stateSelect.value].map(c => `<option value="${c}">${c}</option>`).join("");

            stateSelect.addEventListener("change", () => {
                countySelect.innerHTML = countiesByState[stateSelect.value].map(c => `<option value="${c}">${c}</option>`).join("");
            });

            // ‚úÖ Funci√≥n para mostrar resultado detallado
            function renderPrediction(pred) {
                const resultDiv = document.getElementById("result");
                const confidence = (pred.confidence * 100).toFixed(1);
                const resultClass = pred.predicted_class === 'Fast' ? 'result-fast' : pred.predicted_class === 'Slow' ? 'result-slow' : 'result-moderate';
                const icon = pred.predicted_class === 'Fast' ? 'fa-tachometer-alt' : pred.predicted_class === 'Slow' ? 'fa-exclamation-triangle' : 'fa-traffic-light';

                resultDiv.innerHTML = `
      <div class="fade-in">
        <div class="text-center mb-6">
          <i class="fas ${icon} text-4xl ${resultClass} mb-2"></i>
          <h4 class="text-2xl font-bold ${resultClass}">${pred.predicted_class}</h4>
          <p class="text-gray-600">Velocidad de tr√°fico predicha</p>
        </div>

        <div class="bg-gray-100 rounded-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium">Confianza</span>
            <span class="text-sm font-bold">${confidence}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full" style="width: ${confidence}%"></div>
          </div>
        </div>

        <div class="space-y-3">
          <h5 class="font-semibold text-gray-800 mb-2">Probabilidades detalladas:</h5>
          ${Object.entries(pred.class_probabilities || {}).map(([cls, prob]) => `
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium w-20">${cls}</span>
              <div class="flex-1 mx-3 bg-gray-200 rounded-full h-2">
                <div class="${cls === 'Moderate' ? 'bg-yellow-500' : cls === 'Slow' ? 'bg-red-500' : 'bg-green-500'} h-2 rounded-full" style="width: ${(prob * 100).toFixed(1)}%"></div>
              </div>
              <span class="text-sm font-bold w-12">${(prob * 100).toFixed(1)}%</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
            }

            // ‚úÖ Funci√≥n para mostrar errores
            function showError(title, message) {
                document.getElementById("result").innerHTML = `
      <div class="text-center text-red-600 fade-in">
        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
        <p class="font-semibold">${title}</p>
        <p class="text-sm mt-1">${message}</p>
      </div>
    `;
            }

            // ‚úÖ Enviar formulario
            document.getElementById("predictForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                for (let key in data) if (!isNaN(data[key]) && data[key] !== "") data[key] = Number(data[key]);

                document.getElementById("result").innerHTML = `
      <div class="loading-spinner mb-4"></div>
      <div class="text-gray-600"><i class="fas fa-cog fa-spin mr-2"></i>Analizando datos del tr√°fico...</div>
    `;

                try {
                    const res = await fetch("https://server-congestion-predictor-production.up.railway.app/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                    const json = await res.json();

                    if (json.status === "success") {
                        renderPrediction(json.prediction);
                    } else {
                        showError("Error en la predicci√≥n", json.detail || "No se pudo procesar la solicitud.");
                    }
                } catch {
                    showError("Error de conexi√≥n", "No se pudo conectar con la API.");
                }
            });
        });
    </script>
</body>

</html>